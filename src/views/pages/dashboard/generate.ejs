<% layout('layouts/dashboard.layout') %>

<% block('subTitle', 'Generate Token') %>

<h2 class="section-title"><i class="fas fa-key"></i> Generate New Token</h2>

<div class="token-generator">
  <div class="token-display-container" id="tokenDisplayContainer">
    <div class="token-display" id="tokenOutput"></div>
    <button class="copy-btn" id="copyBtn" title="Copy to clipboard">
      <i class="far fa-copy"></i>
    </button>
  </div>

  <form id="generate-form" action="#" method="POST">
    <textarea class="token-description" placeholder="Add description for this token (optional)..."></textarea>
    <button type="submit" class="generate-btn" id="generateBtn"><i class="fas fa-plus-circle"></i> Generate Token</button>
  </form>
</div>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function initCopyButton() {
      const copyBtn = document.getElementById('copyBtn');
      const tokenOutput = document.getElementById('tokenOutput');

      copyBtn.addEventListener('click', () => {
        const tokenText = tokenOutput.textContent;
        navigator.clipboard.writeText(tokenText).then(() => {
          toastr.success('Token copied to clipboard!', 'Generate Token');
        }).catch(err => {
          toastr.error('Failed to copy token.', 'Generate Token');
        });
      });
    }
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function initHandler() {
      const form = document.getElementById('generate-form');
      const generateBtn = document.getElementById('generateBtn');
      const tokenOutput = document.getElementById('tokenOutput');
      const tokenContainer = document.getElementById('tokenDisplayContainer');

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        tokenContainer.style.display = 'none';

        const description = form.querySelector('.token-description').value;

        if (!description) {
          toastr.error('Please add a description for the token.', 'Generate Token');
          return;
        }

        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        try {
          const response = await fetch("${route('dashboard/generate')}", {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ description })
          });

          if (response.ok) {
            const data = await response.json();
            tokenOutput.textContent = data.data.redeem_code;
            tokenContainer.style.display = 'flex';
            toastr.success('Token generated successfully!', 'Generate Token');
          } else {
            const errorData = await response.json();
            toastr.error(errorData.message, 'Generate Token');
          }
        } catch (error) {
          toastr.error('An error occurred while generating the token.', 'Generate Token');
        } finally {
          generateBtn.disabled = false;
          generateBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Generate Token';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', initHandler);
    document.addEventListener('DOMContentLoaded', initCopyButton);
  </script>
`) %>
