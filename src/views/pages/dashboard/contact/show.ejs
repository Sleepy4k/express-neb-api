<% layout('layouts/dashboard.layout') %>

<% block('subTitle', 'Token History' ) %>

<% block('addon-style', `
  <link rel="stylesheet" href="${asset('vendor/datatables/css/datatables.min.css')}" nonce="${cspNonce}" />
  <style nonce="${cspNonce}">
    .dt-search label i {
      margin-right: 0.5rem !important;
    }
    .delimiter {
      margin: 0 5px;
    }
    .btn-danger {
      color: #dc3545;
    }
    .btn-danger:hover {
      color: #f18993;
    }
    .btn-primary {
      color: #3528ea;
    }
    .btn-primary:hover {
      color: #9993f2;
    }
    a {
      text-decoration: none;
    }
  </style>
`) %>

<h2 class="section-title"><i class="fas fa-history"></i> Token History</h2>

<div class="token-table-container">
  <table class="token-table">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Message</th>
        <th>Created At</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <% contacts.forEach((contact) => { %>
        <tr>
          <td><%= contact.name %></td>
          <td><%= contact.email %></td>
          <td><%= contact.message %></td>
          <td class="timestamp"><%= contact.createdAt ?? '-' %></td>
          <td>
            <% if (contact.file_url) { %>
              <a href="<%= route('storage/contact/' + contact.file_url) %>" target="_blank" rel="noopener" class="btn btn-primary">
                <i class="fas fa-eye"></i>
              </a>
            <% } %>

            <% if (contact.file_url && canDeleteContact) { %>
              <span class="delimiter">|</span>
            <% } %>

            <% if (canDeleteContact) { %>
              <a href="#" class="btn btn-danger" id="btn-delete" data-subject="<%= contact.subject %>" data-id="<%= contact.id %>">
                <i class="fas fa-trash"></i>
              </a>
            <% } %>

            <% if (!contact.file_url && !canDeleteContact) { %>
              <span>-</span>
            <% } %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<% block('addon-script', `
  <script src="${asset('vendor/datatables/js/datatables.min.js')}" nonce="${cspNonce}" defer></script>
  <script nonce="${cspNonce}">
    async function handleDeleteButton(event, subject, id) {
      event.preventDefault();

      if (!confirm('Are you sure you want to delete this contact?')) {
        return;
      }

      const actionURL = "${route('dashboard/contact')}" + '/' + subject + '/' + id;
      const response = await fetch(actionURL, {
        method: 'DELETE',
        headers: {
          Accept: 'application/json',
          'Content-Type': 'application/json',
          'X-CSRF-Token': '${csrfToken}',
        }
      });

      if (response.ok) {
        const data = await response.json();
        toastr.success(data.message, 'Delete Contact');
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        const errorData = await response.json();
        toastr.error(errorData.message, 'Delete Contact');
      }
    }

    function initButtonHandler() {
      const deleteButtons = document.querySelectorAll('#btn-delete');
      deleteButtons.forEach((button) => {
        button.addEventListener('click', (event) => {
          const subject = button.getAttribute('data-subject');
          const id = button.getAttribute('data-id');
          handleDeleteButton(event, subject, id);
        });
      });
    }
  </script>
  <script nonce="${cspNonce}">
    function initDataTable() {
      $.ajax({
        url: "${route('api/datatable/config')}",
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          const updatedData = {
            ...data.data,
            order: [[3, "desc"]],
          };
          const table = $('.token-table').DataTable(updatedData);
        },
        error: function (error) {
          console.error('Error fetching DataTable configuration:', error);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      initDataTable();
      initButtonHandler();
    });
  </script>
`) %>