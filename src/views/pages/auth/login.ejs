<% layout('layouts/auth.layout') %>

<% block('subTitle', 'Sign In') %>

<div class="login-container">
  <div class="login-card">
    <div class="login-header">
      <a href="<%= redirect_url %>" class="btn-back btn-back-header">
        <i class="bi bi-arrow-left"></i>
      </a>
      <h3><i class="bi bi-shield-lock me-2"></i>Sign In</h3>
      <p class="mb-0">
        Sign in to your NEB account to access the admin dashboard.
      </p>
    </div>

    <div class="login-body">
      <form id="signin-form" action="#" method="POST">
        <div class="mb-3">
          <label for="email" class="form-label">Email</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
            <input type="email" class="form-control" id="email" placeholder="admin@neb.com" autocomplete="email" required />
          </div>
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">Password</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            <input type="password" class="form-control" id="password" placeholder="***************" autocomplete="current-password" required />
            <span class="input-group-text password-toggle" id="togglePassword">
              <i class="bi bi-eye"></i>
            </span>
          </div>
        </div>

        <button type="submit" class="btn btn-login btn-primary mb-3">Sign In</button>
      </form>
    </div>
  </div>
</div>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function initPasswordHandler() {
      const togglePassword = document.getElementById('togglePassword');
      const passwordInput = document.getElementById('password');

      togglePassword.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        const icon = togglePassword.querySelector('i');
        icon.classList.toggle('bi-eye', !isPassword);
        icon.classList.toggle('bi-eye-slash', isPassword);
        passwordInput.type = isPassword ? 'text' : 'password';
        passwordInput.placeholder = isPassword ? 'your password' : '***************';
      });
    }
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function initErrorHandler() {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      if (!error || error === '') return;

      switch (error) {
        case 'verify':
          toastr.error('Our system detected illegal action during the authentication process', 'Sign In');
          break;
        default:
          break;
      }

      const newUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
      window.history.replaceState({ path: newUrl }, '', newUrl);
    }
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function initHandler() {
      const form = document.getElementById('signin-form');
      const submitButton = form.querySelector('button[type="submit"]');
      const searchParams = new URLSearchParams(window.location.search);
      const currentUrlQuery = searchParams.toString() ? '?' + searchParams.toString() : '';

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        if (!email || !password) {
          toastr.error('Please fill in all fields.', 'Sign In');
          return;
        }

        submitButton.disabled = true;
        submitButton.value = 'Loading...';

        toastr.info('Processing your request...', 'Sign In');

        try {
          const response = await fetch("${route('login')}" + currentUrlQuery, {
            method: 'POST',
            body: JSON.stringify({
              email: email,
              password: password
            }),
            headers: {
              'X-CSRF-Token': '${csrfToken}',
              'Accept': 'application/json',
              'Content-Type': 'application/json',
            }
          });

          if (response.ok) {
            const { message, data } = await response.json();
            const { redirect_url, verificator } = data;

            toastr.success(message, 'Sign In');
            toastr.info('Redirecting...', 'Sign In');

            setTimeout(() => {
              toastr.clear();
              window.location.href = redirect_url + (verificator ? "?verificator=" + verificator : '');
            }, 750);
          } else {
            const errorData = await response.json();
            toastr.error(errorData.message, 'Sign In');
          }
        } catch (error) {
          toastr.error('An error occurred while signing in.', 'Sign In');
        } finally {
          submitButton.disabled = false;
          submitButton.value = 'Sign In';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', initHandler);
    document.addEventListener('DOMContentLoaded', initErrorHandler);
    document.addEventListener('DOMContentLoaded', initPasswordHandler);
  </script>
`) %>
