<% layout('layouts/main.layout') %>

<% block('subTitle', 'Safe Exam Browser') %>

<% block('addon-style', `
  <link rel="stylesheet" href="${asset('vendor/bootstrap-icons/font/bootstrap-icons.min.css')}" nonce="${cspNonce}" />
  <link rel="stylesheet" href="${asset('vendor/toastr/css/toastr.min.css')}" nonce="${cspNonce}" />
  <style nonce="${cspNonce}">
    .result-part {
      display: none;
    }
  </style>
`) %>

<main class="services">
  <div class="container">
    <div class="upload-section">
      <h1>Upload File</h1>
      <p class="subtitle">Upload your SEB Config securely and easily</p>

      <form id="service-form" class="upload-form" action="#" method="POST" enctype="multipart/form-data">
        <div class="input-group animate-delay-1">
          <input type="text" class="form-control" name="redeem_code" id="redeem_code" placeholder="Enter Redeem Code" />
        </div>

        <div class="input-group animate-delay-2">
          <input type="text" class="form-control" name="file_name" id="file_name" placeholder="Enter Name File" />
        </div>

        <div class="file-upload animate-delay-3">
          <input type="file" class="form-control" name="file" id="file" accept=".seb" />
        </div>

        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="submit-btn">
            <i class="bi bi-upload"></i>Upload
          </button>
          <button type="button" class="btn btn-primary result-part" id="download-btn">
            <i class="bi bi-download"></i>Download
          </button>
        </div>
      </form>
    </div>

    <div class="configurations animate-delay-4">
      <h3 class="result-part" id="resultContainerTitle">Generated Configurations</h3>
      <div class="config-grid" id="resultContainer"></div>
    </div>
  </div>
</main>

<% block('addon-script', `
  <script src="${asset('vendor/jquery/jquery-3.7.1.min.js')}" nonce="${cspNonce}"></script>
  <script src="${asset('vendor/toastr/js/toastr.min.js')}" nonce="${cspNonce}"></script>
  <script nonce="${cspNonce}">
    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": true,
      "progressBar": false,
      "positionClass": "toast-top-right",
      "preventDuplicates": true,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    };
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function downloadResult() {
      const downloadBtn = document.getElementById('download-btn');
      const resultContainer = document.getElementById('resultContainer');

      downloadBtn.addEventListener('click', () => {
        const formattedJsonData = {
          shortTitle: "",
          title: "",
          version: 2,
          headers: []
        };

        let fileName = "result";

        const cardData = Array.from(resultContainer.children).map((colDiv) => {
          const cardBody = colDiv.querySelector('.card-body');
          return {
            name: cardBody.querySelector('.card-title').textContent,
            value: cardBody.querySelector('.card-text').textContent
          }
        });

        cardData.forEach((item) => {
          const name = item.name.toLowerCase();

          if (name === 'file-name') {
            fileName = item.value;
            formattedJsonData.title = item.value;
            formattedJsonData.shortTitle = item.value.charAt(0).toUpperCase();
          } else {
            formattedJsonData.headers.push({
              enabled: false,
              name: item.name,
              value: item.value,
              ...(name !== 'user-agent' && { appendMode: false })
            });
          }
        });

        const blob = new Blob([JSON.stringify(formattedJsonData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toastr.success('File downloaded successfully!', 'Service');
      });
    }
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function showResult(data) {
      const downloadBtn = document.getElementById('download-btn');
      const resultContainer = document.getElementById('resultContainer');
      const resultContainerTitle = document.getElementById('resultContainerTitle');

      resultContainer.innerHTML = '';
      downloadBtn.style.display = 'flex';
      resultContainerTitle.style.display = 'block';

      for (let index = 0; index < data.length; index++) {
        const element = data[index];
        const card = document.createElement('div');
        card.className = 'config-card';

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';

        const cardTitle = document.createElement('h5');
        cardTitle.className = 'card-title';
        cardTitle.innerHTML = '<i class="bi bi-file-code"></i>'+element.name;

        const cardText = document.createElement('p');
        cardText.className = 'card-text';
        cardText.textContent = element.value;

        cardBody.appendChild(cardTitle);
        cardBody.appendChild(cardText);
        card.appendChild(cardBody);
        resultContainer.appendChild(card);
      }
    }
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function initHandler() {
      const form = document.getElementById('service-form');
      const submitButton = document.getElementById('submit-btn');
      const downloadBtn = document.getElementById('download-btn');
      const resultContainerTitle = document.getElementById('resultContainerTitle');
      const searchParams = new URLSearchParams(window.location.search);
      const currentUrlQuery = searchParams.toString() ? '?' + searchParams.toString() : '';

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        downloadBtn.style.display = 'none';
        resultContainerTitle.style.display = 'none';

        const redeemCode = document.getElementById('redeem_code').value;
        const fileName = document.getElementById('file_name').value;
        const fileInput = document.getElementById('file');

        if (!redeemCode || !fileName || !fileInput || fileInput.files.length === 0) {
          toastr.error('Please fill in all fields and select a file.', 'Service');
          return;
        }

        if (fileInput.files[0].name.split('.').pop() !== 'seb') {
          toastr.error('Please select a valid .seb file.', 'Service');
          return;
        }

        const formData = new FormData();
        formData.append('redeem_code', redeemCode);
        formData.append('file_name', fileName);
        formData.append('file', fileInput.files[0]);

        submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Sending...';
        submitButton.setAttribute('disabled', 'disabled');

        toastr.info('Processing your request...', 'Service');

        try {
          const response = await fetch("${route('service/seb')}/" + redeemCode + currentUrlQuery, {
            method: 'POST',
            body: formData,
            headers: {
              Accept: 'application/json'
            }
          });

          if (response.ok) {
            const data = await response.json();
            toastr.success(data.message, 'Service');
            showResult(data.data);
            form.reset();
          } else {
            const errorData = await response.json();
            toastr.error(errorData.message, 'Service');
          }
        } catch (error) {
          toastr.error('An error occurred while uploading the file.', 'Service');
        } finally {
          submitButton.innerHTML = '<i class="bi bi-upload"></i>Upload';
          submitButton.removeAttribute('disabled');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initHandler();
      downloadResult();
    });
  </script>
`) %>
