<% layout('layouts/main.layout') %>

<% block('addon-style', `
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" />
  <style type="text/css">
    #json_block {
      width: 85%;
      height: 85%;
      margin: 15px;
    }
    #json_data {
      font-size: 14px;
      color: #000;
    }
  </style>
`) %>

<section class="ftco-section contact-section ftco-no-pb" id="contact-section">
  <div class="container">
    <div class="row justify-content-center mb-5 pb-3">
      <div class="col-md-7 heading-section text-center">
        <form action="<%= route('awikwok/generate') %>" class="bg-light p-5 contact-form">
          <div class="form-group">
            <input type="text" class="form-control" name="name" id="name" placeholder="Name of User" />
          </div>

          <div class="d-flex">
            <div class="form-group mr-2">
              <input type="submit" value="Generate Redeem Code" class="btn btn-primary" />
            </div>

            <div class="form-group mr-2">
              <span style="display: none;" id="findRoute"><%= route('awikwok/list') %></span>
              <a href="#" class="btn btn-secondary" id="find_code">Find Generated Code</a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="row justify-content-center mb-5 pb-3" id="generated_code_box" style="display: none;">
      <div class="col-md-7 heading-section text-center">
        <h2 class="mb-4">Generated Redeem Code</h2>
        <p>
          Here is the generated redeem code for the user.
        </p>
      </div>

      <div class="col-md-7 heading-section text-center">
        <div class="form-group mr-2">
          <input type="text" class="form-control" name="redeem_code" id="redeem_code" value="" readonly />
        </div>
      </div>
    </div>

    <div class="row justify-content-center mb-5 pb-3" id="detail_code_box" style="display: none;">
      <div class="col-md-6 d-flex">
        <div id="map" class="bg-gray" style="overflow-x: scroll;">
<!-- Don't change this block due bugged on web ui (so crucial) -->
          <pre id="json_block">
<code id="json_data"></code>
          </pre>
        </div>
      </div>
    </div>
  </div>
</section>


<% block('addon-script', `
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
  <script>
    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": true,
      "progressBar": false,
      "positionClass": "toast-top-right",
      "preventDuplicates": true,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    };
  </script>

  <script>
    const json_data = document.getElementById('json_data');
    json_data.innerHTML = JSON.stringify({}, null, 2);
  </script>

  <script>
    function hideAllBox() {
      document.getElementById('generated_code_box').style.display = 'none';
      document.getElementById('detail_code_box').style.display = 'none';
    }
  </script>

  <script>
    const form = document.querySelector('.contact-form');
    const formURL = form.getAttribute('action');

    const user_name = document.getElementById('name');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      hideAllBox();

      const user_name_value = user_name.value;

      // Clear the previous data and input
      user_name.value = null;

      // Make button disabled and change text to loading
      const submitButton = form.querySelector('input[type="submit"]');
      submitButton.disabled = true;
      submitButton.value = 'Loading...';

      toastr.info('Processing your request...', 'Admin');

      const response = await fetch(formURL, {
        method: 'POST',
        body: JSON.stringify({ name: user_name_value }),
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      // Make button enabled and change text to bypass
      submitButton.disabled = false;
      submitButton.value = 'Generate Redeem Code';

      if (data.status === 'error') {
        toastr.error(data.message, 'Admin');
        return;
      }

      document.getElementById('generated_code_box').style.display = 'block';
      document.getElementById('redeem_code').value = data.data.redeem_code;
    });
  </script>

  <script>
    const findFormUrl = document.getElementById('findRoute').innerText;

    const find_code = document.getElementById('find_code');
    const redeem_code = document.getElementById('redeem_code');

    find_code.addEventListener('click', async (event) => {
      hideAllBox();
      event.preventDefault();

      const user_name_value = user_name.value;

      // Clear the previous data and input
      user_name.value = null;

      // Make button disabled and change text to loading
      find_code.disabled = true;
      find_code.innerHTML = 'Loading...';

      toastr.info('Processing your request...', 'Admin');

      const response = await fetch(findFormUrl + '/' + user_name_value, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        }
      });

      const data = await response.json();

      // Make button enabled and change text to bypass
      find_code.disabled = false;
      find_code.innerHTML = 'Find Generated Code';

      if (data.status === 'error') {
        toastr.error(data.message, 'Admin');
        return;
      }

      document.getElementById('detail_code_box').style.display = 'block';
      json_data.innerHTML = JSON.stringify(data.data, null, 2);
    });
  </script>
`) %>
