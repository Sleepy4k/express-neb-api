<% layout('layouts/main.layout') %>

<% block('subTitle', 'Contact Us') %>

<% block('addon-style', `
  <link rel="stylesheet" href="${asset('vendor/bootstrap-icons/font/bootstrap-icons.min.css')}" nonce="${cspNonce}" />
  <link rel="stylesheet" href="${asset('vendor/toastr/css/toastr.min.css')}" nonce="${cspNonce}" />
`) %>

<main class="contact-page">
  <div class="container">
    <div class="contact-header text-center animate__animated" data-animation="animate__fadeIn">
      <h1>Contact Us</h1>
      <p class="subtitle">Have questions or need support? Send us a message</p>
    </div>

    <div class="contact-form animate__animated" data-animation="animate__fadeInUp">
      <form id="contact-form" action="#" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" class="form-control" placeholder="Enter your full name" required>
        </div>

        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
        </div>

        <div class="form-group">
          <label for="subject">Subject</label>
          <select id="subject" class="form-control" required>
            <option value="" disabled selected>Select your inquiry</option>
            <% subjects.forEach(subject => { %>
              <option value="<%= subject.value %>"><%= subject.name %></option>
            <% }) %>
          </select>
        </div>

        <div class="form-group">
          <label for="message">Message</label>
          <textarea id="message" class="form-control" rows="4" placeholder="Describe your inquiry in detail" required></textarea>
        </div>

        <div class="form-group" id="image-container">
          <label for="imageFile">Image</label>
          <div class="file-upload">
            <input type="file" id="imageFile" class="form-control" accept="image/*, .pdf">
            <small class="text-muted">Upload screenshot or PDF of your issue (Max 5MB)</small>
          </div>
        </div>

        <div class="form-submit">
          <button type="submit" class="btn btn-primary" id="submit-btn">
            <i class="bi bi-send-fill me-2"></i>Submit Inquiry
          </button>
        </div>
      </form>
    </div>
  </div>
</main>

<% block('addon-script', `
  <script src="${asset('vendor/jquery/jquery-3.7.1.min.js')}" nonce="${cspNonce}"></script>
  <script src="${asset('vendor/toastr/js/toastr.min.js')}" nonce="${cspNonce}"></script>
  <script nonce="${cspNonce}">
    toastr.options = {
      "closeButton": true,
      "debug": false,
      "newestOnTop": true,
      "progressBar": false,
      "positionClass": "toast-top-right",
      "preventDuplicates": true,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "5000",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    };
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function handleImageContainer() {
      const imageContainer = document.getElementById('image-container');
      const imageFileInput = document.getElementById('imageFile');

      imageFileInput.addEventListener('change', () => {
        const file = imageFileInput.files[0];
        if (!file) return;

        const fileSize = file.size / 1024 / 1024;
        if (fileSize <= 5) return;

        toastr.error('File size exceeds 5MB. Please upload a smaller file.');
        imageFileInput.value = '';
      });
    }
  </script>
`) %>

<% block('addon-script', `
  <script nonce="${cspNonce}">
    function initHandler() {
      const form = document.getElementById('contact-form');
      const submitButton = document.getElementById('submit-btn');
      const searchParams = new URLSearchParams(window.location.search);
      const currentUrlQuery = searchParams.toString() ? '?' + searchParams.toString() : '';

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const subject = document.getElementById('subject').value;
        const message = document.getElementById('message').value;

        if (!name || !email || !subject || !message) {
          toastr.error('Please fill in all fields');
          return;
        }

        let subjectArray = "${subjects.map(subject => subject.value)}";
        subjectArray = subjectArray.split(',').map(item => item.trim());

        if (!subjectArray.includes(subject)) {
          toastr.error('Invalid subject selected');
          return;
        }

        submitButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Sending...';
        submitButton.setAttribute('disabled', 'disabled');

        const formData = new FormData();
        formData.append('name', name);
        formData.append('email', email);
        formData.append('subject', subject);
        formData.append('message', message);

        const imageFileInput = document.getElementById('imageFile');
        if (imageFileInput && imageFileInput.files.length > 0) {
          formData.append('file', imageFileInput.files[0]);
        }

        try {
          const response = await fetch("${route('contact')}" + currentUrlQuery, {
            method: 'POST',
            body: formData,
            headers: {
              Accept: 'application/json'
            }
          });

          if (response.ok) {
            toastr.success('Your message has been sent successfully!');
            form.reset();
          } else {
            toastr.error('Failed to send your message. Please try again later.');
          }
        } catch (error) {
          toastr.error('An error occurred while sending your message. Please try again later.');
        } finally {
          submitButton.innerHTML = '<i class="bi bi-send-fill me-2"></i>Submit Inquiry';
          submitButton.removeAttribute('disabled');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initHandler();
      handleImageContainer();
    });
  </script>
`) %>
